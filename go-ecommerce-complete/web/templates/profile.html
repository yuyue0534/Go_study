<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººä¸­å¿ƒ - ç”µå•†å¹³å°</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container navbar-content">
            <a href="/" class="navbar-brand">ğŸ›’ ç”µå•†å¹³å°</a>
            <ul class="navbar-menu">
                <li><a href="/">é¦–é¡µ</a></li>
                <li><a href="/products">å•†å“</a></li>
            </ul>
            <div class="navbar-user"></div>
        </div>
    </nav>

    <div class="container" style="margin-top: 30px; margin-bottom: 60px;">
        <h2 style="margin-bottom: 30px;">ä¸ªäººä¸­å¿ƒ</h2>
        
        <div class="card mb-20">
            <div class="card-header">ä¸ªäººä¿¡æ¯</div>
            <div class="card-body" id="userInfo"></div>
        </div>

        <div class="card">
            <div class="card-header flex-between">
                <span>æ”¶è´§åœ°å€</span>
                <button class="btn btn-sm btn-primary" onclick="showAddAddressModal()">+ æ–°å¢åœ°å€</button>
            </div>
            <div class="card-body" id="addressesSection"></div>
        </div>
    </div>

    <!-- æ–°å¢åœ°å€æ¨¡æ€æ¡† -->
    <div id="addAddressModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">æ–°å¢æ”¶è´§åœ°å€</span>
                <span class="modal-close" onclick="closeAddAddressModal()">&times;</span>
            </div>
            <form id="addAddressForm">
                <div class="form-group">
                    <label>æ”¶è´§äºº</label>
                    <input type="text" name="receiver_name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>æ‰‹æœºå·</label>
                    <input type="tel" name="phone" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>çœä»½</label>
                    <input type="text" name="province" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>åŸå¸‚</label>
                    <input type="text" name="city" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>åŒºå¿</label>
                    <input type="text" name="district" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>è¯¦ç»†åœ°å€</label>
                    <textarea name="detail_address" class="form-control" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" name="is_default"> è®¾ä¸ºé»˜è®¤åœ°å€</label>
                </div>
                <button type="submit" class="btn btn-primary btn-block">ä¿å­˜</button>
            </form>
        </div>
    </div>

    <script src="/static/js/common.js"></script>
    <script>
        async function loadUserInfo() {
            const user = await getCurrentUser();
            if (user) {
                document.getElementById('userInfo').innerHTML = `
                    <div style="padding: 10px 0;">
                        <div style="margin-bottom: 10px;"><strong>ç”¨æˆ·åï¼š</strong>${user.username}</div>
                        <div style="margin-bottom: 10px;"><strong>é‚®ç®±ï¼š</strong>${user.email}</div>
                        <div style="margin-bottom: 10px;"><strong>æ‰‹æœºå·ï¼š</strong>${user.phone || 'æœªè®¾ç½®'}</div>
                        <div><strong>è§’è‰²ï¼š</strong>${user.role === 'admin' ? 'ç®¡ç†å‘˜' : user.role === 'seller' ? 'å•†å®¶' : 'æ™®é€šç”¨æˆ·'}</div>
                    </div>
                `;
            }
        }

        async function loadAddresses() {
            const data = await request('/api/addresses');
            if (data.success) {
                renderAddresses(data.addresses);
            }
        }

        function renderAddresses(addresses) {
            const section = document.getElementById('addressesSection');
            if (addresses.length === 0) {
                section.innerHTML = '<div class="empty-state"><p>æš‚æ— æ”¶è´§åœ°å€</p></div>';
                return;
            }

            section.innerHTML = addresses.map(addr => `
                <div class="card" style="margin-bottom: 10px;">
                    <div class="card-body flex-between">
                        <div>
                            ${addr.is_default ? '<span class="badge badge-success">é»˜è®¤</span> ' : ''}
                            <strong>${addr.receiver_name}</strong> ${addr.phone}
                            <div style="margin-top: 5px; color: #666;">
                                ${addr.province} ${addr.city} ${addr.district} ${addr.detail_address}
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline" onclick="deleteAddress(${addr.id})">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        async function deleteAddress(addressId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåœ°å€å—ï¼Ÿ')) return;

            const data = await request(`/api/addresses/${addressId}`, { method: 'DELETE' });
            if (data.success) {
                showToast('åœ°å€å·²åˆ é™¤', 'success');
                loadAddresses();
            } else {
                showToast(data.message, 'danger');
            }
        }

        function showAddAddressModal() {
            document.getElementById('addAddressModal').classList.add('show');
        }

        function closeAddAddressModal() {
            document.getElementById('addAddressModal').classList.remove('show');
            document.getElementById('addAddressForm').reset();
        }

        document.getElementById('addAddressForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const addressData = {
                receiver_name: formData.get('receiver_name'),
                phone: formData.get('phone'),
                province: formData.get('province'),
                city: formData.get('city'),
                district: formData.get('district'),
                detail_address: formData.get('detail_address'),
                is_default: formData.get('is_default') === 'on'
            };

            const data = await request('/api/addresses/add', {
                method: 'POST',
                body: JSON.stringify(addressData)
            });

            if (data.success) {
                showToast('åœ°å€æ·»åŠ æˆåŠŸ', 'success');
                closeAddAddressModal();
                loadAddresses();
            } else {
                showToast(data.message, 'danger');
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            loadUserInfo();
            loadAddresses();
        });
    </script>
</body>
</html>
