<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´­ç‰©è½¦ - ç”µå•†å¹³å°</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container navbar-content">
            <a href="/" class="navbar-brand">ğŸ›’ ç”µå•†å¹³å°</a>
            <ul class="navbar-menu">
                <li><a href="/">é¦–é¡µ</a></li>
                <li><a href="/products">å•†å“</a></li>
            </ul>
            <div class="navbar-user"></div>
        </div>
    </nav>

    <div class="container" style="margin-top: 30px; margin-bottom: 60px;">
        <h2 style="margin-bottom: 30px;">è´­ç‰©è½¦</h2>
        <div id="cartContent"></div>
        <div id="cartSummary" style="display: none;" class="card mt-20">
            <div class="card-body">
                <div class="flex-between">
                    <div style="font-size: 18px;">
                        å·²é€‰ <span id="selectedCount">0</span> ä»¶å•†å“
                    </div>
                    <div>
                        <span style="font-size: 14px; color: #666;">æ€»ä»·ï¼š</span>
                        <span id="totalAmount" style="font-size: 24px; color: var(--primary-color); font-weight: bold;"></span>
                    </div>
                </div>
                <button class="btn btn-primary btn-block mt-20" onclick="checkout()">å»ç»“ç®—</button>
            </div>
        </div>
    </div>

    <script src="/static/js/common.js"></script>
    <script>
        let cartItems = [];

        async function loadCart() {
            const data = await request('/api/cart');
            if (data.success) {
                cartItems = data.items;
                renderCart();
            }
        }

        function renderCart() {
            const content = document.getElementById('cartContent');
            const summary = document.getElementById('cartSummary');

            if (cartItems.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ›’</div>
                        <p>è´­ç‰©è½¦æ˜¯ç©ºçš„</p>
                        <a href="/products" class="btn btn-primary mt-20">å»è´­ç‰©</a>
                    </div>
                `;
                summary.style.display = 'none';
                return;
            }

            content.innerHTML = `
                <div class="card">
                    <table class="table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                <th>å•†å“</th>
                                <th>å•ä»·</th>
                                <th>æ•°é‡</th>
                                <th>å°è®¡</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${cartItems.map(item => `
                                <tr id="item-${item.id}">
                                    <td><input type="checkbox" class="item-checkbox" data-id="${item.id}" onchange="updateSummary()"></td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 15px;">
                                            <img src="${item.image_url}" alt="${item.name}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 5px;">
                                            <div>
                                                <div style="font-weight: 500;">${item.name}</div>
                                                <div style="color: #999; font-size: 12px;">åº“å­˜: ${item.stock}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>${formatPrice(item.price)}</td>
                                    <td>
                                        <input type="number" value="${item.quantity}" min="1" max="${item.stock}" 
                                               style="width: 80px;" class="form-control"
                                               onchange="updateQuantity(${item.id}, this.value)">
                                    </td>
                                    <td><strong>${formatPrice(item.price * item.quantity)}</strong></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline" onclick="removeItem(${item.id})">åˆ é™¤</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            summary.style.display = 'block';
            updateSummary();
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.item-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateSummary();
        }

        function updateSummary() {
            const checkboxes = document.querySelectorAll('.item-checkbox:checked');
            let count = 0;
            let total = 0;

            checkboxes.forEach(cb => {
                const itemId = parseInt(cb.dataset.id);
                const item = cartItems.find(i => i.id === itemId);
                if (item) {
                    count += item.quantity;
                    total += item.price * item.quantity;
                }
            });

            document.getElementById('selectedCount').textContent = count;
            document.getElementById('totalAmount').textContent = formatPrice(total);
        }

        async function updateQuantity(itemId, quantity) {
            quantity = parseInt(quantity);
            const item = cartItems.find(i => i.id === itemId);
            
            if (quantity < 1 || quantity > item.stock) {
                showToast('æ•°é‡è¶…å‡ºèŒƒå›´', 'danger');
                document.querySelector(`#item-${itemId} input[type=number]`).value = item.quantity;
                return;
            }

            const data = await request('/api/cart/update', {
                method: 'POST',
                body: JSON.stringify({ cart_item_id: itemId, quantity })
            });

            if (data.success) {
                item.quantity = quantity;
                renderCart();
            } else {
                showToast(data.message, 'danger');
            }
        }

        async function removeItem(itemId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä»¶å•†å“å—ï¼Ÿ')) return;

            const data = await request('/api/cart/remove', {
                method: 'POST',
                body: JSON.stringify({ cart_item_id: itemId })
            });

            if (data.success) {
                showToast('å·²åˆ é™¤', 'success');
                cartItems = cartItems.filter(i => i.id !== itemId);
                renderCart();
            }
        }

        function checkout() {
            const selected = Array.from(document.querySelectorAll('.item-checkbox:checked'))
                .map(cb => parseInt(cb.dataset.id));

            if (selected.length === 0) {
                showToast('è¯·é€‰æ‹©è¦ç»“ç®—çš„å•†å“', 'warning');
                return;
            }

            localStorage.setItem('checkout_items', JSON.stringify(selected));
            window.location.href = '/checkout';
        }

        document.addEventListener('DOMContentLoaded', loadCart);
    </script>
</body>
</html>
