<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“åˆ—è¡¨ - ç”µå•†å¹³å°</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container navbar-content">
            <a href="/" class="navbar-brand">ğŸ›’ ç”µå•†å¹³å°</a>
            <ul class="navbar-menu">
                <li><a href="/">é¦–é¡µ</a></li>
                <li><a href="/products">å•†å“</a></li>
            </ul>
            <div class="navbar-user"></div>
        </div>
    </nav>

    <div class="container" style="margin-top: 30px; margin-bottom: 60px;">
        <div style="display: flex; gap: 30px;">
            <!-- å·¦ä¾§ç­›é€‰æ  -->
            <div style="flex: 0 0 250px;">
                <div class="card">
                    <div class="card-header">ç­›é€‰æ¡ä»¶</div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>æœç´¢</label>
                            <input type="text" id="searchInput" class="form-control" placeholder="æœç´¢å•†å“">
                        </div>
                        <div class="form-group">
                            <label>åˆ†ç±»</label>
                            <select id="categorySelect" class="form-control">
                                <option value="">å…¨éƒ¨åˆ†ç±»</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æ’åº</label>
                            <select id="sortSelect" class="form-control">
                                <option value="latest">æœ€æ–°ä¸Šæ¶</option>
                                <option value="price_asc">ä»·æ ¼ä»ä½åˆ°é«˜</option>
                                <option value="price_desc">ä»·æ ¼ä»é«˜åˆ°ä½</option>
                            </select>
                        </div>
                        <button class="btn btn-primary btn-block" onclick="loadProducts(1)">åº”ç”¨ç­›é€‰</button>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§å•†å“åˆ—è¡¨ -->
            <div style="flex: 1;">
                <div id="productsGrid" class="products-grid"></div>
                <div id="pagination" class="pagination"></div>
            </div>
        </div>
    </div>

    <script src="/static/js/common.js"></script>
    <script>
        let currentPage = 1;

        async function loadCategories() {
            const data = await request('/api/categories');
            if (data.success) {
                const select = document.getElementById('categorySelect');
                data.categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    select.appendChild(option);
                });

                const urlParams = new URLSearchParams(window.location.search);
                const categoryId = urlParams.get('category');
                if (categoryId) {
                    select.value = categoryId;
                }
            }
        }

        async function loadProducts(page = 1) {
            currentPage = page;
            const category = document.getElementById('categorySelect').value;
            const search = document.getElementById('searchInput').value;
            const sort = document.getElementById('sortSelect').value;

            let url = `/api/products?page=${page}&sort=${sort}`;
            if (category) url += `&category_id=${category}`;
            if (search) url += `&search=${encodeURIComponent(search)}`;

            const data = await request(url);
            if (data.success) {
                renderProducts(data.products);
                renderPagination(data.page, data.pages);
            }
        }

        function renderProducts(products) {
            const grid = document.getElementById('productsGrid');
            if (products.length === 0) {
                grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“¦</div><p>æš‚æ— å•†å“</p></div>';
                return;
            }

            grid.innerHTML = products.map(product => `
                <div class="product-card" onclick="window.location.href='/product/${product.id}'">
                    <img src="${product.image_url}" alt="${product.name}" class="product-image">
                    <div class="product-info">
                        <div class="product-name" title="${product.name}">${product.name}</div>
                        <div class="product-price">${formatPrice(product.price)}</div>
                        <div style="color: #999; font-size: 12px; margin-top: 5px;">åº“å­˜: ${product.stock}</div>
                        <button class="btn btn-primary btn-sm btn-block" style="margin-top: 10px;" 
                                onclick="event.stopPropagation(); addToCart(${product.id})">
                            åŠ å…¥è´­ç‰©è½¦
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderPagination(page, totalPages) {
            const pagination = document.getElementById('pagination');
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';
            html += `<button onclick="loadProducts(${page - 1})" ${page === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>`;
            
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= page - 2 && i <= page + 2)) {
                    html += `<button class="${i === page ? 'active' : ''}" onclick="loadProducts(${i})">${i}</button>`;
                } else if (i === page - 3 || i === page + 3) {
                    html += '<button disabled>...</button>';
                }
            }
            
            html += `<button onclick="loadProducts(${page + 1})" ${page === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>`;
            pagination.innerHTML = html;
        }

        async function addToCart(productId) {
            const user = await getCurrentUser();
            if (!user) {
                showToast('è¯·å…ˆç™»å½•', 'warning');
                setTimeout(() => window.location.href = '/login', 1000);
                return;
            }

            const data = await request('/api/cart/add', {
                method: 'POST',
                body: JSON.stringify({ product_id: productId, quantity: 1 })
            });

            if (data.success) {
                showToast('å·²æ·»åŠ åˆ°è´­ç‰©è½¦', 'success');
            } else {
                showToast(data.message, 'danger');
            }
        }

        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loadProducts(1);
        });

        document.addEventListener('DOMContentLoaded', () => {
            loadCategories();
            loadProducts(1);
        });
    </script>
</body>
</html>
