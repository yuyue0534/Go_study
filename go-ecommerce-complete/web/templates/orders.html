<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„è®¢å• - ç”µå•†å¹³å°</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container navbar-content">
            <a href="/" class="navbar-brand">ğŸ›’ ç”µå•†å¹³å°</a>
            <ul class="navbar-menu">
                <li><a href="/">é¦–é¡µ</a></li>
                <li><a href="/products">å•†å“</a></li>
            </ul>
            <div class="navbar-user"></div>
        </div>
    </nav>

    <div class="container" style="margin-top: 30px; margin-bottom: 60px;">
        <h2 style="margin-bottom: 30px;">æˆ‘çš„è®¢å•</h2>
        <div id="ordersSection"></div>
    </div>

    <script src="/static/js/common.js"></script>
    <script>
        async function loadOrders() {
            const data = await request('/api/orders');
            if (data.success) {
                renderOrders(data.orders);
            }
        }

        function renderOrders(orders) {
            const section = document.getElementById('ordersSection');
            
            if (orders.length === 0) {
                section.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“¦</div>
                        <p>æš‚æ— è®¢å•</p>
                        <a href="/products" class="btn btn-primary mt-20">å»è´­ç‰©</a>
                    </div>
                `;
                return;
            }

            section.innerHTML = orders.map(order => `
                <div class="card mb-20">
                    <div class="card-header flex-between">
                        <div>
                            <strong>è®¢å•å·ï¼š</strong>${order.order_no}
                            <span style="margin-left: 20px;">${formatDate(order.created_at)}</span>
                        </div>
                        <div>${getOrderStatusBadge(order.status)}</div>
                    </div>
                    <div class="card-body">
                        ${order.items.map(item => `
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                                <div style="flex: 1;">
                                    <strong>${item.product_name}</strong>
                                    <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                        ${formatPrice(item.product_price)} Ã— ${item.quantity}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: bold;">${formatPrice(item.subtotal)}</div>
                                </div>
                            </div>
                        `).join('')}
                        <div style="text-align: right; padding-top: 15px;">
                            <span style="font-size: 14px; color: #666;">è®¢å•æ€»é¢ï¼š</span>
                            <span style="font-size: 20px; color: var(--primary-color); font-weight: bold;">
                                ${formatPrice(order.total_amount)}
                            </span>
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); color: #666;">
                            <div><strong>æ”¶è´§äººï¼š</strong>${order.receiver_name} ${order.receiver_phone}</div>
                            <div style="margin-top: 5px;"><strong>æ”¶è´§åœ°å€ï¼š</strong>${order.shipping_address}</div>
                            ${order.tracking_number ? `<div style="margin-top: 5px;"><strong>ç‰©æµå•å·ï¼š</strong>${order.tracking_number}</div>` : ''}
                        </div>
                    </div>
                    <div class="card-footer" style="text-align: right;">
                        ${order.status === 'pending_payment' ? `
                            <button class="btn btn-sm btn-primary" onclick="payOrder(${order.id})">ç«‹å³æ”¯ä»˜</button>
                            <button class="btn btn-sm btn-outline" onclick="cancelOrder(${order.id})">å–æ¶ˆè®¢å•</button>
                        ` : ''}
                        ${order.status === 'pending_shipment' ? `
                            <button class="btn btn-sm btn-outline" onclick="cancelOrder(${order.id})">å–æ¶ˆè®¢å•</button>
                        ` : ''}
                        ${order.status === 'shipped' ? `
                            <button class="btn btn-sm btn-primary">ç¡®è®¤æ”¶è´§</button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function payOrder(orderId) {
            if (!confirm('ç¡®è®¤æ”¯ä»˜å—ï¼Ÿï¼ˆè¿™æ˜¯æ¨¡æ‹Ÿæ”¯ä»˜ï¼‰')) return;

            const data = await request(`/api/orders/${orderId}/pay`, { method: 'POST' });
            if (data.success) {
                showToast('æ”¯ä»˜æˆåŠŸ', 'success');
                loadOrders();
            } else {
                showToast(data.message, 'danger');
            }
        }

        async function cancelOrder(orderId) {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆè®¢å•å—ï¼Ÿ')) return;

            const data = await request(`/api/orders/${orderId}/cancel`, { method: 'POST' });
            if (data.success) {
                showToast('è®¢å•å·²å–æ¶ˆ', 'success');
                loadOrders();
            } else {
                showToast(data.message, 'danger');
            }
        }

        document.addEventListener('DOMContentLoaded', loadOrders);
    </script>
</body>
</html>
