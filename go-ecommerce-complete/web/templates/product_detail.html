<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“è¯¦æƒ… - ç”µå•†å¹³å°</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container navbar-content">
            <a href="/" class="navbar-brand">ğŸ›’ ç”µå•†å¹³å°</a>
            <ul class="navbar-menu">
                <li><a href="/">é¦–é¡µ</a></li>
                <li><a href="/products">å•†å“</a></li>
            </ul>
            <div class="navbar-user"></div>
        </div>
    </nav>

    <div class="container" style="margin-top: 30px; margin-bottom: 60px;">
        <div id="productDetail"></div>
        <div class="card mt-20">
            <div class="card-header">å•†å“è¯„ä»·</div>
            <div class="card-body" id="reviewsSection"></div>
        </div>
    </div>

    <script src="/static/js/common.js"></script>
    <script>
        const productId = {{ product_id }};

        async function loadProduct() {
            const data = await request(`/api/product/${productId}`);
            if (data.success) {
                renderProduct(data.product);
                renderReviews(data.reviews);
            } else {
                document.getElementById('productDetail').innerHTML = 
                    '<div class="empty-state"><p>å•†å“ä¸å­˜åœ¨</p></div>';
            }
        }

        function renderProduct(product) {
            document.getElementById('productDetail').innerHTML = `
                <div class="card">
                    <div class="card-body" style="display: flex; gap: 40px;">
                        <div style="flex: 0 0 400px;">
                            <img src="${product.image_url}" alt="${product.name}" 
                                 style="width: 100%; border-radius: 8px;">
                        </div>
                        <div style="flex: 1;">
                            <h1 style="margin-bottom: 20px;">${product.name}</h1>
                            <div style="color: #999; margin-bottom: 20px;">${product.description || 'æš‚æ— æè¿°'}</div>
                            <div style="font-size: 32px; color: var(--primary-color); font-weight: bold; margin-bottom: 20px;">
                                ${formatPrice(product.price)}
                            </div>
                            <div style="margin-bottom: 15px;">
                                <span style="color: #666;">å“ç‰Œï¼š</span>
                                <span>${product.brand || 'æ— '}</span>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <span style="color: #666;">åº“å­˜ï¼š</span>
                                <span>${product.stock > 0 ? product.stock + ' ä»¶' : 'æš‚æ— åº“å­˜'}</span>
                            </div>
                            <div style="margin-top: 30px; display: flex; gap: 10px;">
                                <input type="number" id="quantity" value="1" min="1" max="${product.stock}" 
                                       class="form-control" style="width: 100px;">
                                <button class="btn btn-primary" onclick="addToCart()" ${product.stock === 0 ? 'disabled' : ''}>
                                    åŠ å…¥è´­ç‰©è½¦
                                </button>
                                <button class="btn btn-secondary" onclick="buyNow()" ${product.stock === 0 ? 'disabled' : ''}>
                                    ç«‹å³è´­ä¹°
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderReviews(reviews) {
            const section = document.getElementById('reviewsSection');
            if (reviews.length === 0) {
                section.innerHTML = '<div class="empty-state"><p>æš‚æ— è¯„ä»·</p></div>';
                return;
            }

            section.innerHTML = reviews.map(review => `
                <div style="border-bottom: 1px solid var(--border-color); padding: 15px 0;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <div>
                            <strong>${review.username}</strong>
                            <span style="margin-left: 15px;">
                                ${'â­'.repeat(review.rating)}${'â˜†'.repeat(5 - review.rating)}
                            </span>
                        </div>
                        <div style="color: #999; font-size: 12px;">
                            ${formatDate(review.created_at)}
                        </div>
                    </div>
                    <div>${review.comment || 'ç”¨æˆ·æœªå¡«å†™è¯„è®º'}</div>
                    ${review.replies && review.replies.length > 0 ? `
                        <div style="margin-left: 30px; margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                            ${review.replies.map(reply => `
                                <div>
                                    <strong>${reply.username}ï¼š</strong>${reply.content}
                                    <span style="color: #999; font-size: 12px; margin-left: 10px;">
                                        ${formatDate(reply.created_at)}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        async function addToCart() {
            const user = await getCurrentUser();
            if (!user) {
                showToast('è¯·å…ˆç™»å½•', 'warning');
                setTimeout(() => window.location.href = '/login', 1000);
                return;
            }

            const quantity = parseInt(document.getElementById('quantity').value);
            const data = await request('/api/cart/add', {
                method: 'POST',
                body: JSON.stringify({ product_id: productId, quantity })
            });

            if (data.success) {
                showToast('å·²æ·»åŠ åˆ°è´­ç‰©è½¦', 'success');
            } else {
                showToast(data.message, 'danger');
            }
        }

        async function buyNow() {
            const user = await getCurrentUser();
            if (!user) {
                showToast('è¯·å…ˆç™»å½•', 'warning');
                setTimeout(() => window.location.href = '/login', 1000);
                return;
            }

            await addToCart();
            setTimeout(() => window.location.href = '/cart', 500);
        }

        document.addEventListener('DOMContentLoaded', loadProduct);
    </script>
</body>
</html>
