<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»“ç®— - ç”µå•†å¹³å°</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container navbar-content">
            <a href="/" class="navbar-brand">ğŸ›’ ç”µå•†å¹³å°</a>
        </div>
    </nav>

    <div class="container" style="margin-top: 30px; margin-bottom: 60px;">
        <h2 style="margin-bottom: 30px;">ç¡®è®¤è®¢å•</h2>
        
        <div class="card mb-20">
            <div class="card-header flex-between">
                <span>æ”¶è´§åœ°å€</span>
                <button class="btn btn-sm btn-primary" onclick="showAddAddressModal()">+ æ–°å¢åœ°å€</button>
            </div>
            <div class="card-body" id="addressesSection"></div>
        </div>

        <div class="card mb-20">
            <div class="card-header">å•†å“æ¸…å•</div>
            <div class="card-body" id="itemsSection"></div>
        </div>

        <div class="card mb-20">
            <div class="card-header">æ”¯ä»˜æ–¹å¼</div>
            <div class="card-body">
                <label><input type="radio" name="payment" value="alipay" checked> æ”¯ä»˜å®</label>
                <label style="margin-left: 20px;"><input type="radio" name="payment" value="wechat"> å¾®ä¿¡æ”¯ä»˜</label>
                <label style="margin-left: 20px;"><input type="radio" name="payment" value="card"> é“¶è¡Œå¡</label>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <div class="flex-between mb-20">
                    <span style="font-size: 18px;">è®¢å•æ€»é¢ï¼š</span>
                    <span id="totalAmount" style="font-size: 24px; color: var(--primary-color); font-weight: bold;"></span>
                </div>
                <button class="btn btn-primary btn-block" onclick="submitOrder()">æäº¤è®¢å•</button>
            </div>
        </div>
    </div>

    <!-- æ–°å¢åœ°å€æ¨¡æ€æ¡† -->
    <div id="addAddressModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">æ–°å¢æ”¶è´§åœ°å€</span>
                <span class="modal-close" onclick="closeAddAddressModal()">&times;</span>
            </div>
            <form id="addAddressForm">
                <div class="form-group">
                    <label>æ”¶è´§äºº</label>
                    <input type="text" name="receiver_name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>æ‰‹æœºå·</label>
                    <input type="tel" name="phone" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>çœä»½</label>
                    <input type="text" name="province" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>åŸå¸‚</label>
                    <input type="text" name="city" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>åŒºå¿</label>
                    <input type="text" name="district" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>è¯¦ç»†åœ°å€</label>
                    <textarea name="detail_address" class="form-control" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" name="is_default"> è®¾ä¸ºé»˜è®¤åœ°å€</label>
                </div>
                <button type="submit" class="btn btn-primary btn-block">ä¿å­˜</button>
            </form>
        </div>
    </div>

    <script src="/static/js/common.js"></script>
    <script>
        let addresses = [];
        let cartItems = [];
        let selectedAddress = null;

        async function loadAddresses() {
            const data = await request('/api/addresses');
            if (data.success) {
                addresses = data.addresses;
                renderAddresses();
            }
        }

        function renderAddresses() {
            const section = document.getElementById('addressesSection');
            if (addresses.length === 0) {
                section.innerHTML = '<div class="empty-state"><p>è¯·æ·»åŠ æ”¶è´§åœ°å€</p></div>';
                return;
            }

            section.innerHTML = addresses.map(addr => `
                <div class="card" style="margin-bottom: 10px; cursor: pointer; border: 2px solid ${selectedAddress === addr.id ? 'var(--primary-color)' : 'transparent'};"
                     onclick="selectAddress(${addr.id})">
                    <div class="card-body">
                        ${addr.is_default ? '<span class="badge badge-success">é»˜è®¤</span> ' : ''}
                        <strong>${addr.receiver_name}</strong> ${addr.phone}
                        <div style="margin-top: 5px; color: #666;">
                            ${addr.province} ${addr.city} ${addr.district} ${addr.detail_address}
                        </div>
                    </div>
                </div>
            `).join('');

            if (!selectedAddress && addresses.length > 0) {
                selectedAddress = addresses[0].id;
                renderAddresses();
            }
        }

        function selectAddress(addressId) {
            selectedAddress = addressId;
            renderAddresses();
        }

        async function loadCartItems() {
            const checkoutItems = JSON.parse(localStorage.getItem('checkout_items') || '[]');
            if (checkoutItems.length === 0) {
                window.location.href = '/cart';
                return;
            }

            const data = await request('/api/cart');
            if (data.success) {
                cartItems = data.items.filter(item => checkoutItems.includes(item.id));
                renderItems();
            }
        }

        function renderItems() {
            const section = document.getElementById('itemsSection');
            let total = 0;

            section.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>å•†å“</th>
                            <th>å•ä»·</th>
                            <th>æ•°é‡</th>
                            <th>å°è®¡</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${cartItems.map(item => {
                            const subtotal = item.price * item.quantity;
                            total += subtotal;
                            return `
                                <tr>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 15px;">
                                            <img src="${item.image_url}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 5px;">
                                            <div>${item.name}</div>
                                        </div>
                                    </td>
                                    <td>${formatPrice(item.price)}</td>
                                    <td>${item.quantity}</td>
                                    <td><strong>${formatPrice(subtotal)}</strong></td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('totalAmount').textContent = formatPrice(total);
        }

        function showAddAddressModal() {
            document.getElementById('addAddressModal').classList.add('show');
        }

        function closeAddAddressModal() {
            document.getElementById('addAddressModal').classList.remove('show');
            document.getElementById('addAddressForm').reset();
        }

        document.getElementById('addAddressForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const addressData = {
                receiver_name: formData.get('receiver_name'),
                phone: formData.get('phone'),
                province: formData.get('province'),
                city: formData.get('city'),
                district: formData.get('district'),
                detail_address: formData.get('detail_address'),
                is_default: formData.get('is_default') === 'on'
            };

            const data = await request('/api/addresses/add', {
                method: 'POST',
                body: JSON.stringify(addressData)
            });

            if (data.success) {
                showToast('åœ°å€æ·»åŠ æˆåŠŸ', 'success');
                closeAddAddressModal();
                loadAddresses();
            } else {
                showToast(data.message, 'danger');
            }
        });

        async function submitOrder() {
            if (!selectedAddress) {
                showToast('è¯·é€‰æ‹©æ”¶è´§åœ°å€', 'warning');
                return;
            }

            const payment = document.querySelector('input[name=payment]:checked').value;
            const cartItemIds = cartItems.map(item => item.id);

            const data = await request('/api/orders/create', {
                method: 'POST',
                body: JSON.stringify({
                    cart_item_ids: cartItemIds,
                    address_id: selectedAddress,
                    payment_method: payment
                })
            });

            if (data.success) {
                localStorage.removeItem('checkout_items');
                showToast('è®¢å•åˆ›å»ºæˆåŠŸ', 'success');
                setTimeout(() => {
                    window.location.href = `/orders`;
                }, 1500);
            } else {
                showToast(data.message, 'danger');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadAddresses();
            loadCartItems();
        });
    </script>
</body>
</html>
